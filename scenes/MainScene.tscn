[gd_scene load_steps=6 format=2]

[ext_resource path="res://scenes/PieHUD.tscn" type="PackedScene" id=1]
[ext_resource path="res://scenes/PlayerCharacter.tscn" type="PackedScene" id=2]

[sub_resource type="GDScript" id=1]

script/source = "extends Spatial

const WorldMap = preload(\"res://scripts/WorldMap.gd\")

onready var character: KinematicBody = get_node(@\"PlayerCharacter\")
onready var PIEHUD = get_node(@\"CanvasLayer/PieHUD\")

onready var map: WorldMap = WorldMap.new(preload(\"res://world-1544060774196.png\"), self)
onready var timer: Timer = Timer.new()

func _on_PlayerCharacter_activate_pie() -> void:
    PIEHUD.visible = true
    
func _on_PieHUD_pie_released(position: Vector2, slice: String, tier: int) -> void:
    var camera: Camera = get_viewport().get_camera()
    var from := camera.project_ray_origin(position)
    var to: Vector3 = from + camera.project_ray_normal(position) * 1000
    var intersection := Plane.PLANE_XZ.intersects_ray(from, to)
    character.throw_potion(intersection, slice, tier)

func _check_if_need_chunk() -> void:
    var camera: Camera = get_viewport().get_camera()
    var half_size: float = camera.size / 2
    var camera_translation: Vector3 = camera.global_transform.origin
    var center := Vector2(camera_translation.x + half_size, camera_translation.z + half_size)
    var chunk_pos: Vector2 = (center / WorldMap.UNITS_PER_CHUNK).floor()
    map.load_chunk(chunk_pos)

func _ready() -> void:
#    character.translate(Vector3(2100 * UNITS_PER_PIXEL, 0, 546 * UNITS_PER_PIXEL))
    _check_if_need_chunk()
    add_child(timer)
    timer.wait_time = 0.5
    timer.process_mode = Timer.TIMER_PROCESS_PHYSICS
    timer.connect(\"timeout\", self, \"_check_if_need_chunk\")
    timer.start()
"

[sub_resource type="ProceduralSky" id=2]


[sub_resource type="Environment" id=3]

background_mode = 2
background_sky = SubResource( 2 )
tonemap_mode = 2

[node name="GameWorld" type="Spatial"]
script = SubResource( 1 )

[node name="Sun" type="DirectionalLight" parent="."]
transform = Transform( 1, 0, 0, 0, 0.707107, 0.707107, 0, -0.707107, 0.707107, 0, 14, 0 )
shadow_enabled = true
directional_shadow_mode = 0
directional_shadow_split_1 = 0.25
directional_shadow_split_2 = 0.5
directional_shadow_split_3 = 1.0
directional_shadow_depth_range = 1
directional_shadow_max_distance = 100.0

[node name="WorldEnvironment" type="WorldEnvironment" parent="Sun"]
environment = SubResource( 3 )

[node name="CanvasLayer" type="CanvasLayer" parent="."]

[node name="PieHUD" parent="CanvasLayer" instance=ExtResource( 1 )]

[node name="PlayerCharacter" parent="." instance=ExtResource( 2 )]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 19.724 )

[connection signal="pie_released" from="CanvasLayer/PieHUD" to="." method="_on_PieHUD_pie_released"]
[connection signal="activate_pie" from="PlayerCharacter" to="." method="_on_PlayerCharacter_activate_pie"]
[connection signal="activate_pie" from="PlayerCharacter" to="." method="_on_Character_activate_pie"]
